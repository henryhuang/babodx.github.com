--- 
categories: []
comments: true
layout: post
title: "CentOS 5.4 基于HP Proliant DL380 G5服务器配置Modular Smart Array 1000存储"
---
原来单位的存储一直是分两个800G的区，挂在到Windows下。Windows的系统总要担心病毒，所以打算迁移到CentOS Linux下。
参考了<a href="http://blog.s135.com/post/415/">http://blog.s135.com/post/415/</a>这篇文章，但是他的文章里是单控制器，并且没有用到光纤。所以配置上有些不同
<strong>硬件配置</strong>
一台HP MSA 1000存储设备（包含两个Modular Smart Array 1000控制器）
一台HP Storage SAN 4/8光纤交换机
一台HP Proliant DL380 G5 2U服务器
七块SCSI 300G硬盘
一块HP StorageWorks FC1142SR 4GB PCI-E 光纤卡
<img alt="" width="400" height="429" src="http://xinlogs.com/attachment/1268291756_3323fe38.jpg">
从两个Modular Smart Array 1000的控制器后面连接光纤到光纤交换机。然后将光纤卡安装到服务器上，用光纤连接光纤卡到光纤交换机。
<img alt="" width="200" height="214" src="http://xinlogs.com/attachment/1268291876_430536d8.jpg"><img alt="" width="200" height="214" src="http://xinlogs.com/attachment/1268291876_1749bde7.jpg">
<strong>软件配置</strong>
先对各种硬件的fireware进行下更新。
从惠普网站下载update fireware光盘，下载的文件为firmware-8.60-0.zip，大小463M左右，然后解压刻成光盘
下载地址<a href="ftp://ftp.hp.com/pub/softlib2/software1/cd/p1040529012/v53483/firmware-8.60-0.zip">ftp://ftp.hp.com/pub/softlib2/software1/cd/p1040529012/v53483/firmware-8.60-0.zip</a>
用光盘启动服务器，然后安装提示做就可以。它会更新网卡、服务器等设备的fireware。都是自动检测并更新的，很简单
确保各种fireware都更新后，下面需要用到smartstart光盘来对存储进行配置了
从惠普网站下载smartstart光盘，下载的文件smartstart-8.30-0-x86.zip，大小576M左右，也是解压刻录光盘
下载地址<a href="ftp://ftp.hp.com/pub/softlib2/software1/cd/p1040463476/v49882/smartstart-8.30-0-x86.zip">ftp://ftp.hp.com/pub/softlib2/software1/cd/p1040463476/v49882/smartstart-8.30-0-x86.zip</a>
然后用光盘启动服务器，按照提示进入后，选择第2项配置存储卡，第一项是用来安装操作系统的，我发现没有Linux的操作系统。。。都是Windows系列。
可以发现服务器自己的raid卡 HP Smart Array E200和MSA 1000存储。
我是先将服务器的3块硬盘组成一个Raid 5，然后再配置MSA 1000的存储，也是将7块盘组成Raid 5。我看了下资料，说raid 6比raid5要损失8%-15%的性能，但是可以保证同时坏2块盘不丢失数据。不过我觉得raid5够用了。
因为是双控制器，我这里的fireware是4.48所以采用的是active/standby模式。如果打算用active/active模式，需要更新fireware到7.0版本
用smartstart光盘做好raid后，就可以给服务器安装系统了。
<strong>安装CentOS 5.4 64bit</strong>
安装CentOS 5.4 64bit版本前，先将连接到服务器的光纤拔掉，要不系统总是提示/dev/sda不可读取，这里的sda就是我们存储。
一切安装正常安装就可以。
正常安装后，连接好光纤，再启动服务器。
这个时候因为没有安装驱动，服务器在启动过程中会报很多end_request: error
而且我还发现如果不安装驱动，我们可以通过fdisk -l查找到存储设备，但是每次重启或者存储关机再开，存储的设备名都会变，有时候是/dev/sda有时候是/dev/sdb。所以很难在/etc/fstab里写入mount的配置。
<strong>安装HBA卡驱动</strong>
到HP网站下载驱动
<a href="http://h20000.www2.hp.com/bizsupport/TechSupport/SoftwareIndex.jsp?lang=en&cc=us&prodNameId=1809832&prodTypeId=12169&prodSeriesId=1809835&swLang=8&taskId=135&swEnvOID=4004">http://h20000.www2.hp.com/bizsupport/TechSupport/SoftwareIndex.jsp?lang=en&cc=us&prodNameId=1809832&prodTypeId=12169&prodSeriesId=1809835&swLang=8&taskId=135&swEnvOID=4004</a>
也可以直接下载
<a href="ftp://ftp.hp.com/pub/softlib/software10/COL19426/co-74973-1/hp_qla2x00-2009-03-17.tar.gz">ftp://ftp.hp.com/pub/softlib/software10/COL19426/co-74973-1/hp_qla2x00-2009-03-17.tar.gz</a>
<a href="ftp://ftp.hp.com/pub/softlib/software11/COL28061/co-69719-3/hp-fc-enablement-2009-12-16.tar.gz">ftp://ftp.hp.com/pub/softlib/software11/COL28061/co-69719-3/hp-fc-enablement-2009-12-16.tar.gz</a>
上面两个文件，一个是qla2x00的驱动，后面一个是Linux fibre channel enablement kits for QLogic HBAs and mezzanine cards
下载后解压安装

<table cellspacing="1" cellpadding="0" width="100%"><tbody>
<tr>
<td>
            <h3 class="title2" style="margin-top: 4pt; font-family: Arial; margin-bottom: 0pt; font-size: 10pt">
<a name="d0e2456"></a>Installation instructions</h3>
            </td>
        </tr>
<tr>
<td bgcolor="#0066ff" height="4"> </td>
        </tr>
</tbody></table>
<div class="procedure" style="margin-left: 0pt">
<ol type="1" style="font-family: Arial; color: #000000; margin-left: 20pt; font-size: 10pt">
<li>
    Download the appropriate driver kit for your distribution. The driver kit file will be in the format <code class="computeroutput" style="font-size: 10pt">hp_qla2x00-yyyy-mm-dd.tar.gz</code>.
    </li>
    <li>
    Copy the driver kit to the target system.
    </li>
    <li>
    Uncompress and untar the driver kit using the following command:
    <code class="command" style="font-size: 10pt"># tar zxvf hp_qla2x00-yyyy-mm-dd.tar.gz</code>
    </li>
    <li>
    Change directory to the <code class="computeroutput" style="font-size: 10pt">hp_qla2x00-yyyy-mm-dd</code> directory.
    </li>
    <li>
    Execute the <code class="command" style="font-size: 10pt">INSTALL</code> command.
    The <code class="command" style="font-size: 10pt">INSTALL</code> command syntax will vary depending on your conﬁguration. If a previous driver kit is installed, you can invoke the <code class="command" style="font-size: 10pt">INSTALL</code> command without any arguments as the script will use the currently loaded conﬁguration:
    <code class="command" style="font-size: 10pt"># ./INSTALL</code>
    To force the installation to failover mode, use the <code class="computeroutput" style="font-size: 10pt">-f</code> ﬂag:
    <code class="command" style="font-size: 10pt"># ./INSTALL -f</code>
    To force the installation to single-path mode, use the <code class="computeroutput" style="font-size: 10pt">-s</code> ﬂag:
    <code class="command" style="font-size: 10pt"># ./INSTALL -s</code>
    Use the <code class="command" style="font-size: 10pt">-h</code> option of the <code class="command" style="font-size: 10pt">INSTALL</code> script for a list of all supported arguments. The <code class="command" style="font-size: 10pt">INSTALL</code> script will install the appropriate driver RPM for your conﬁguration, as well as the appropriate ﬁbreutils RPM. Once the <code class="command" style="font-size: 10pt">INSTALL</code> script is ﬁnished, you will either have to reload the QLogic driver modules (qla2xxx, qla2300, qla2400, qla2xxx_conf) or reboot your server.
    The commands to reload the driver are:
    <code class="command" style="font-size: 10pt"># /opt/hp/src/hp_qla2x00src/unload.sh</code>
    <code class="command" style="font-size: 10pt"># modprobe qla2xxx_conf</code>
    <code class="command" style="font-size: 10pt"># modprobe qla2xxx</code>
    <code class="command" style="font-size: 10pt"># modprobe qla2300</code>
    <code class="command" style="font-size: 10pt"># modprobe qla2400</code>
    The command to reboot the server is:
    <code class="command" style="font-size: 10pt"># reboot</code>
    <div class="caution" style="margin-left: 0.5in; margin-right: 0.5in">
    <table border="0" cellspacing="1" summary="Caution" cellpadding="0"><tbody>
<tr>
<td> </td>
                <td bgcolor="#555555" height="3"> </td>
            </tr>
<tr>
<td valign="top" rowspan="2" width="25" align="center"> </td>
                <th align="left"> </th>
            </tr>
<tr>
<td valign="top" align="left">
                <span style="font-weight: bold">CAUTION: </span>If your boot device is a SAN attached device you will have to reboot your server.
                </td>
            </tr>
<tr>
<td> </td>
                <td bgcolor="#555555" height="1"> </td>
            </tr>
<tr>
<td height="10" colspan="2"> </td>
            </tr>
</tbody></table>
</div>
    </li>
</ol>
</div>
To verify which RPM versions are installed, use the <code class="command" style="font-size: 10pt">rpm</code> command with the <code class="command" style="font-size: 10pt">-q</code> option.
For example:
<code class="command" style="font-size: 10pt"># rpm -q hp_qla2x00src</code>
<code class="command" style="font-size: 10pt"># rpm –q fibreutils</code>
然后在继续安装HP Fibre Channel Enablement Kit

<table cellspacing="1" cellpadding="0" width="100%"><tbody>
<tr>
<td>
            <h3 class="title2" style="margin-top: 4pt; font-family: Arial; margin-bottom: 0pt; font-size: 10pt">
<a name="d0e2332"></a>Installing the HP Fibre Channel Enablement Kit</h3>
            </td>
        </tr>
<tr>
<td bgcolor="#0066ff" height="4"> </td>
        </tr>
</tbody></table>To install the HP Fibre Channel Enablement Kit, do the following:
<div class="orderedlist">
<ol type="1" style="font-family: Arial; color: #000000; margin-left: 20pt; font-size: 10pt">
<li>
    Download the <code class="computeroutput" style="font-size: 10pt">hp-fc-enablement-yyyy-mm-dd.tar.gz</code> file for your operating system and copy it to the target server
    </li>
    <li>
    Untar the enablement kit by executing the command to create the directory, <code class="command" style="font-size: 10pt">hp-fc-enablement-yyyy-mm-dd</code>.
    <code class="command" style="font-size: 10pt"># tar zxvf hp-fc-enablement-yyyy-mm-dd.tar.gz</code>
    </li>
    <li>
    Browse to the directory <code class="command" style="font-size: 10pt">hp-fc-enablement-yyyy-mm-dd</code>.
    </li>
    <li>
    Do one of the following to execute the <code class="command" style="font-size: 10pt">install.sh</code> script.
    <div class="orderedlist">
    <ol type="a" style="font-family: Arial; color: #000000; margin-left: 20pt; font-size: 10pt">
<li>
        If you are not using Device Mapper multipathing execute the following command:
        <code class="command" style="font-size: 10pt"># ./install.sh -s </code>
        </li>
        <li>
        If you are using Device Mapper multipathing execute the following command:
        <code class="command" style="font-size: 10pt"># ./install.sh -m</code>
        The <code class="computeroutput" style="font-size: 10pt">hp-fc-enablement</code> and <code class="computeroutput" style="font-size: 10pt">fibreutils</code> RPMs should be installed once this install completes. To verify the installation, enter the following commands:
        <code class="command" style="font-size: 10pt"># rpm -q hp-fc-enablement </code>
        <code class="command" style="font-size: 10pt"># rpm -q fibreutils </code>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in">
        <table border="0" cellspacing="1" summary="Note" cellpadding="0"><tbody>
<tr>
<td> </td>
                    <td bgcolor="#555555" height="3"> </td>
                </tr>
<tr>
<td valign="top" rowspan="2" width="25" align="center"> </td>
                    <th align="left"> </th>
                </tr>
<tr>
<td valign="top" align="left">
                    <span style="font-weight: bold">NOTE: </span>For use with the driver that comes with the kernel you will need fibreutils 3.x or greater.
                    </td>
                </tr>
<tr>
<td> </td>
                    <td bgcolor="#555555" height="1"> </td>
                </tr>
<tr>
<td height="10" colspan="2"> </td>
                </tr>
</tbody></table>
</div>
        </li>
    </ol>
</div>
    </li>
</ol>
</div>
全部完成后，我们需要查看下/etc/modprobe.conf
如果有下面图中标记的一些信息加入，说明上面的驱动安装正确。
<img width="800" height="250" alt="" src="http://xinlogs.com/attachment/1268380135_3698de3f.png">
确实正确后，我们重启下服务器。
当再次进入系统后，我们的存储应该被识别为/dev/sda设备
用fdisk -l /dev/sda查看下，如果没有问题了，就可以使用fdisk /dev/sda进行分区
我是把全部1.6T分成一个区/dev/sda1
然后e2lable /dev/sda1 /data给卷标
在/etc/fstab文件里加入/dev/sda1的挂着位置
这样以后每次启动系统，就自动将存储挂着到系统的/data目录中了。如下图
<img width="500" height="300" alt="" src="http://xinlogs.com/attachment/1268380341_32244d04.png">
<strong>总结</strong>
本来参考<a href="http://www.s135.com">www.s135.com</a>博主的文章配置的，后来发现因为用了光纤卡，不安装驱动会有问题。还有就是双控制器的active/active和active/standby模式需要通过刷新不同的fireware实现。总得来说这个存储配置起来不难，安装官方文档和网络上一些文档就可以。写这篇文档就是为了记录下自己的配置过程，省的以后再配置还要到处找文档查资料。
