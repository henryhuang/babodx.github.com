<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Virtualization | 鑫的方向]]></title>
  <link href="http://babodx.github.com/blog/categories/virtualization/atom.xml" rel="self"/>
  <link href="http://babodx.github.com/"/>
  <updated>2013-02-27T08:21:06+08:00</updated>
  <id>http://babodx.github.com/</id>
  <author>
    <name><![CDATA[babodx]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[安装和使用xen-shell]]></title>
    <link href="http://babodx.github.com/blog/2009/12/21/install-xen-shell/"/>
    <updated>2009-12-21T00:00:00+08:00</updated>
    <id>http://babodx.github.com/blog/2009/12/21/install-xen-shell</id>
    <content type="html"><![CDATA[<p>转自：<a href="http://www.xen-tools.org/software/xen-shell/install.html">http://www.xen-tools.org/software/xen-shell/install.html</a></p>

<p>Installing &amp; using the Xen-Shell</p>

<p>This shell makes several assumptions in the way that it operates:</p>

<ul>
<li>That you have a Xen 3.x host running.</li>
<li>Then Xen host has several guests running.</li>
<li>That you don't wish to give your users shell access on the host.</li>
</ul>


<p>If these assumptions are not valid for your environment then you might find that you have problems.</p>

<p><strong>Installation</strong></p>

<p>Download either <a href="http://www.xen-tools.org/releases.html">a release</a>, or a current version of <a href="http://www.xen-tools.org/cvs.html">the CVS repository</a> and install it by executing:</p>

<p><code>make install</code></p>

<p><strong>Configuring Users</strong></p>

<p>Each user is expected to login directly to the xen-shell, and not have any other access to the host system. To do this change their login shell by running:</p>

<p><code>chsh -s /usr/local/bin/xen-login-shell username</code></p>

<p>This will ensure when they connect to the system they will login to the shell, and run it within GNU Screen.</p>

<p><strong>Note:</strong>CVS and Debian binary packages use /usr/bin instead of /usr/local/.
Once you've changed the shell for the user you must update your Xen configuration files so that they include the username(s) of the users who can control them.
To allow the user "bob" and the user "steve" to control the Xen guest "builder.my.flat" you would add the following to /etc/xen/builder.my.flat.cfg:</p>

<p>```</p>

<h1>All instances must have a name name = 'builder.my.flat'    </h1>

<h1>These users may control this instance. xen_shell = 'bob, steve'</h1>

<p>```</p>

<p><strong>Bandwidth Accounting</strong></p>

<p>The shell allows the user to view the bandwidth they have transferred over a given period, using the bandwidth command.
For this to work the vnstat tool must be installed and configured upon dom0. It is assumed that each Xen guest will have their network interface named the same as the guest name.
For example a Xen guest called 'skx' will have a network interface 'skx' upon dom0. If you're using the standard Xen configuration setup you can achieve this by changing your skx.cfg file to read:</p>

<p><code>vif = [ 'vifname=skx,ip=1.2.3.4' ]</code></p>

<p><strong>Note:</strong> if you have more than one IP address allocated to a guest you will have to create a more complicated setup.</p>

<p><strong>Security</strong></p>

<p>Since the xen administrator command xm requires root privileges to run you will need to configure sudo to allow the users who are running your shell to execute that command, without being prompted for a password, as root.
Add something similar to the following to your /etc/sudoers file:</p>

<p><code>
User_Alias   XENUSERS = steve,bob,fred,foo
Cmnd_Alias   XEN      = /usr/sbin/xm
Cmnd_Alias   XENIMG   = /usr/bin/xen-create-image
XENUSERS     ALL      = NOPASSWD: XEN,XENIMG
</code></p>

<p><strong>Note:</strong>you only need to grant the ability to run xen-create-image if you wish to enable reimaging support in the shell.</p>

<p><strong>DNS Updates</strong></p>

<p>When the shell starts it will look for the file ips.txt in the home directory of the user who connects. If that file doesn't exist then the rdns command will be disabled.</p>

<p>If you wish to allow users to control their reverse DNS create that file and give it contents such as these:</p>

<p><code>192.168.1.1 foo.my.domain 192.168.1.2 bar.my.domain</code></p>

<p>This file will be updated by the user when they invoke the rdns command. It is up to you to read the files and create the corresponding zonefiles / DNS updates. The shell will only manipulate the file - not push DNS updates itself.</p>

<p><strong>Reimaging Support</strong></p>

<p>If a user connects to the shell and has the executable file image.sh in their home directory the reimage command will be enabled.
When the user invokes the command the image.sh script is executed after prompting for confirmation, and performing a last-chance count-down.
It is up to you to create and configure this script to do the right thing. A sample file for user bob could look like this:</p>

<p>```</p>

<h1>!/bin/sh /usr/bin/xen-create-image --hostname=bob \  </h1>

<p>--ip=192.168.1.1  \  
--ip=192.168.1.2 \  
--size=9.5G \  
--swap=512M  --mem=256M \  
--force
```</p>

<p>This will require a correctly configured instance of <a href="http://www.xen-tools.org/software/xen-tools/">xen-tools</a> and the sudoer file to contain the ability for the user to run xen-create-image.</p>

<p>Any remaining questions? <a href="http://www.xen-tools.org/contact/">contact the author</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[怎么mount一个xen的img映像。转载]]></title>
    <link href="http://babodx.github.com/blog/2009/12/21/howto-mount-xen-img/"/>
    <updated>2009-12-21T00:00:00+08:00</updated>
    <id>http://babodx.github.com/blog/2009/12/21/howto-mount-xen-img</id>
    <content type="html"><![CDATA[<ul>
<li>First you need to find out the partitions and the startsector of partitions:</li>
</ul>


<p><code>
[root@xen rruban]# file rheltest.img rheltest.img: x86 boot sector, GRand Unified Bootloader (0.94);
partition
1: ID=0x83, active, starthead 1, startsector 63, 208782 sectors; partition
2: ID=0x8e, starthead 0, startsector 208845, 3871665 sectors, code offset 0x48
</code></p>

<p>There are 3 partitions inside the image file. The startsector of each partition is also listed. Boot partition will have start sector 63.</p>

<ul>
<li>Now you need to get the sector size:</li>
</ul>


<p><code>
[root@xen]fdisk -lu rheltest.img
Disk rheltest.img: 0 MB, 0 bytes 255 heads, 63 sectors/track, 0 cylinders, total 0 sectors
Units = sectors of 1 * 512 = 512 bytes
Device Boot Start End Blocks Id System
rheltest.img1 * 63 208844 104391 83 Linux
rheltest.img2 208845 4080509 1935832+ 8e Linux LVM
</code></p>

<p>The above shows the sector byte size is 512 byte.</p>

<ul>
<li>To calculating the offset: offset = start_sector x sector_byte_size.</li>
</ul>


<p>The startsector is 63 for the first partition, therefore the first partition offset is: 63x512=32256</p>

<ul>
<li>Finally, to mount the xen image, use:</li>
</ul>


<p><code>
mount -o loop,offset=32256 test.img /foldername
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[获取XEN guestOS的images文件]]></title>
    <link href="http://babodx.github.com/blog/2009/12/21/get-xen-guestos-image/"/>
    <updated>2009-12-21T00:00:00+08:00</updated>
    <id>http://babodx.github.com/blog/2009/12/21/get-xen-guestos-image</id>
    <content type="html"><![CDATA[<p>我们可以从<a href="http://stacklet.com/">http://stacklet.com/</a>其实就是原来<a href="http://jailtime.org/">http://jailtime.org/</a>站点找我们需要的xen image文件</p>

<p>在2009年的时候，jailtime.org发布了一个新闻</p>

<h6>May 4th, 2009</h6>

<p>The jailtime project has been relaunched with a new name and site: <a href="http://stacklet.com/">Stacklet</a>
As part of the relaunch all of the distributions currently on jailtime have been upgraded to their latest versions. Also, all of the code for creating the images is now publically available – see <a href="http://stacklet.com/">http://stacklet.com/</a> for further details....
Jailtime will remain online but downloads will probably be turned off eventually as the transition to stacklet proceeds.</p>

<p>所以现在就访问<a href="http://stacklet.com/">http://stacklet.com/</a>就可以了。</p>

<p>包括如下系统</p>

<p><li>
<a href="http://stacklet.com/downloads/images/list/CentOS">CentOS</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/centos/5.3">5.3</a> </li>
<li><a href="http://stacklet.com/downloads/images/centos/5.3.64bit">5.3 (64-bit)</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Debian">Debian</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/debian/5.0">5.0 (Lenny)</a> </li>
<li><a href="http://stacklet.com/downloads/images/debian/5.0.64bit">5.0 (Lenny, 64-bit)</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Fedora">Fedora</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/fedora/10">10</a> </li>
<li><a href="http://stacklet.com/downloads/images/fedora/10.64bit">10 (64-bit)</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Gentoo">Gentoo</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/gentoo/2008-0">2008.0</a> </li>
<li><a href="http://stacklet.com/downloads/images/gentoo/2008-0.64bit">2008.0 (64-bit)</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Mandriva">Mandriva</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/mandriva/2009.0">2009.0</a> </li>
<li><a href="http://stacklet.com/downloads/images/mandriva/2009.0.64bit">2009.0 (64-bit)</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Slackware">Slackware</a> <ul>
<li><a href="http://stacklet.com/node/13">12.2</a></li>
</ul>
</li>
<li>
<a href="http://stacklet.com/downloads/images/list/Ubuntu">Ubuntu</a> <ul>
<li>
<a href="http://stacklet.com/downloads/images/ubuntu/9.04">9.04 (Jaunty)</a> </li>
<li><a href="http://stacklet.com/downloads/images/ubuntu/9.04.64bit">9.04 (Jaunty, 64-bit)</a></li>
</ul>
</li>
</ul></li>
<li></p>

<p><strong>下面是一个站点提供的img文件的简单说明</strong>
<strong>All files on this site are provided without guarantee or warranty. Use at your own risk.</strong>
Each download is a bzipped tarball containing an image and cfg files:</p>

<ul>
<li>a xen guest filesystem
</li>
<li>sample xen configuration files to be used with <strong>xm create</strong>
</li>
</ul>


<p>The naming convention of the download tarball is:
<strong><distribution>.<distro-version>.<created-date>.img.tar.bz2</strong>.
For example centos.5-3.x86.20090423.img.tar.bz2 contains</p>

<ul>
<li>centos.5-3.x86.img
</li>
<li>centos.5-3.x86.xen3.cfg
</li>
<li>centos.5-3.x86.xen3.pygrub.cfg（这个文件比较重要，如果用的是CentOS 5.3的虚拟化，就需要这个文件才可以启动guestOS。因为CentOS 5.3没有提供Xen-U的内核。）
</li>
</ul>


<p>All of the packages installed in the image will be the latest versions available as of the created date, which is in yyyy-mm-dd format.</p>

<h3>Prerequisites</h3>


<ol>
<li>Working installation of Xen version 3
</li>
<li>The xen daemon (xend) must be running
</li>
<li>Enough filesystem space to accomodate the uncompressed tarball (generally 1GB)
</li>
<li>Enough unallocated RAM to run the xen guest (generally 128MB)
</li>
</ol>


<h3>Default Configuration and Networking</h3>


<p>Each filesystem is configured to use dhcp. The *.xen.cfg also is also configured for dhcp. It is recommended that you first test the filesystem using dhcp if possible before attempting other networking parameters. Each download page has additional notes on networking that is appropriate for a particular distribution.
The root login is root/password. It is highly recommened that you change the root password immediately.</p>

<h3>Installation</h3>


<p>You will need to uncompress the tarball to a local directory and edit the *.xen.cfg file to point to the uncompressed image and swap file.
If all is well you will see the guest’s boot messages scrolling by.
<strong>一些HOWTO文档</strong></p>

<h3><strong>HOWTO: Filesystems</strong></h3>


<p>In the following howto’s, <image file> should be replaced with a reference to a specific .img file.</p>

<h4><strong>How do I mount an image without booting it?</strong></h4>


<ul>
<li>mkdir -p /mnt/loop
</li>
<li>mount -o loop <image file> /mnt/loop/
</li>
</ul>


<h4><strong>How do I resize an image file?</strong></h4>


<p>First, make sure that the image file is not already mounted and is not already running as a xen guest. The following commands increase an image file to 2.5GB. Backup the image before attempting this.</p>

<ul>
<li>dd if=/dev/zero of=<image file> bs=1M conv=notrunc count=1 seek=2500 
</li>
<li>losetup /dev/loop0 <image file>
</li>
<li>e2fsck -f /dev/loop0
</li>
<li>resize2fs /dev/loop0
</li>
<li>e2fsck -f /dev/loop0
</li>
<li>losetup -d /dev/loop0
</li>
</ul>


<p>You may then boot or mount the image to confirm the increased size. The e2fsck checks in this howto are not strictly necessary.</p>

<h4><strong>How do I move the contents of an img file to a regular partition?</strong></h4>


<p>Mount the img file using the above howto. Assuming the destination partition is mounted at /mnt/dest, execute the following:</p>

<ul>
<li>cp -a /mnt/loop/* /mnt/dest/
</li>
</ul>


<p>You will then be able to boot the filesystem using the partition instead of the image file, which should provide better performance. You will need to update the *.xen.cfg file to reference the partition instead of the img file (the <strong>disk</strong> parameter will need to change, see the <a href="http://www.cl.cam.ac.uk/Research/SRG/netos/xen/readmes/user/user.html">Xen Manual</a>). Also, remember to unmount partitions or img files before booting a xen guest from them!</p>

<p></li></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CentOS里的Xen配置pygrub]]></title>
    <link href="http://babodx.github.com/blog/2009/12/21/centos-xen-pygrub/"/>
    <updated>2009-12-21T00:00:00+08:00</updated>
    <id>http://babodx.github.com/blog/2009/12/21/centos-xen-pygrub</id>
    <content type="html"><![CDATA[<p>如果用virt-install生成一台虚拟服务器
在查看配置的时候，会发现已经没有了kernel=这个配置来制定启动内核。而是用了</p>

<p><code>bootloader = '/usr/bin/pygrub'</code></p>

<p>关于这个，可以参考
<a href="http://wiki.xensource.com/xenwiki/PyGrub">http://wiki.xensource.com/xenwiki/PyGrub</a></p>

<p>CentOS 5.3的虚拟化，好像没有了XenU的内核，而是改用了这种新的方式。</p>

<p>反正我用kernel启动失败了。后来用这个方式已经可以正常使用虚拟服务器了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CentOS 5.3 安装虚拟化后的内存识别问题.]]></title>
    <link href="http://babodx.github.com/blog/2009/12/21/centos-xen-memory-problem/"/>
    <updated>2009-12-21T00:00:00+08:00</updated>
    <id>http://babodx.github.com/blog/2009/12/21/centos-xen-memory-problem</id>
    <content type="html"><![CDATA[<p>昨天单位到了2台SUN x4450.</p>

<p><strong>硬件配置相当强力.</strong></p>

<p>CPU 4颗6核的 Intel(R) Xeon(R) CPU           X7460 @ 2.66GHz</p>

<p>系统可以识别出24颗处理器</p>

<p><code>
[root@localhost ~]# cat /proc/cpuinfo |grep processor|wc -l
24
</code></p>

<p>内存64G</p>

<p>在内存问题上,我郁闷了一阵子.我用dmesg、free、top查看，都是32G</p>

<p>开始以为CentOS 5.3的64位内核就能支持到32G呢。又尝试在启动参数里加mem=64G</p>

<p>又上论坛询问、查看官方文档，都说CentOS 5.3 64bit应该没有内存限制的。</p>

<p>后来我发现了，原来问题出在安装的虚拟化上面</p>

<p>用xm top可以正确识别内存。而且安装的系统，只是当作xm 里面的一个dom0来运行的。</p>
]]></content>
  </entry>
  
</feed>
